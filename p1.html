<html>
<meta charset="utf-8">
<head>
	<title>P1</title>
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="http://d3js.org/topojson.v2.min.js"></script>
</head>
<body>
<svg id="day" height="600" width="600"></svg>
<svg id="night" height="600" width="600"></svg>

<script>
	function parseDateTime (str) {
		// 11/09/2011 11:33:00 PM +0000
		var split = str.split(" ");

		var date = split[0].split("/");
		var time = split[1].split(":");
		var am = split[2] === "AM";

		var month = parseInt(date[0], 10);
		var day = parseInt(date[1], 10);
		var year = parseInt(date[2], 10);

		var hour = parseInt(time[0], 10);
		var min = parseInt(time[1], 10);
		var sec = parseInt(time[2], 10);

		if (!am && hour <= 12) { //convert to 24 hour for pm
			hour = hour + 12;
		}
		else if (am && hour === 12){ //convert to 24 hour for am
			hour = hour - 12;
		}

		return new Date(year, month, day, hour, min, sec);
	}

	var daySvg = d3.select("#day");
	var nightSvg = d3.select("#night");

	var projection = d3.geoMercator();
	var pathGenerator = d3.geoPath().projection(projection);

	d3.json("city-council-districts.topojson", function (error, data) {
		var districts = topojson.feature(data, data.objects.geo);

		projection.fitExtent([[0,0], [daySvg.attr("width"), daySvg.attr("height")]], districts);
		var paths = daySvg.selectAll("path.district").data(districts.features);
		paths.enter()
		.append("path")
		.merge(paths)
		.attr("style", "fill:green; stroke:black")
		.attr("d", function (district) {
			return pathGenerator(district);
		});

		projection.fitExtent([[0,0], [nightSvg.attr("width"), nightSvg.attr("height")]], districts);
		var paths = nightSvg.selectAll("path.district").data(districts.features);
		paths.enter()
		.append("path")
		.merge(paths)
		.attr("style", "fill:green; stroke:black")
		.attr("d", function (district) {
			return pathGenerator(district);
		});

		showPoints();
	});
	function showPoints() {
		d3.csv("Seattle_911.csv", 
		function row (d) {
			return {
				longitude: d.Longitude,
				latitude: d.Latitude,
				datetime: d.Datetime
			};
		},
		function cb (err, data) {
			var day = [];
			var night = [];
			data.forEach(function (row) {
				var date = parseDateTime(row.datetime);
				if (date.getFullYear() === 2011) {
					if (6 < date.getHours() && date.getHours() < 18) { //day
						day.push([row.longitude, row.latitude]);
					}
					else {
						night.push([row.longitude, row.latitude]);
					}
				}
			});
			var dayCircles = daySvg.selectAll("circle").data(day);
			dayCircles.enter().append("circle").attr("r", 2)
			.attr("style", "stroke:black; fill:black")
			.merge(dayCircles)
			.attr("cx", function(d) { return projection(d)[0]; })
			.attr("cy", function(d) { return projection(d)[1]; });

			var nightCircles = nightSvg.selectAll("circle").data(night);
			nightCircles.enter().append("circle").attr("r", 2)
			.attr("style", "stroke:black; fill:black")
			.merge(nightCircles)
			.attr("cx", function(d) { return projection(d)[0]; })
			.attr("cy", function(d) { return projection(d)[1]; });
		});
	}

</script>
</body>
</html>